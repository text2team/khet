<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>CMS ÄÄƒng bÃ i tá»« file ZIP</title>
  <style>
    body { font-family: Arial; padding: 2rem; max-width: 600px; margin: auto; }
    input, button { width: 100%; padding: 10px; margin: 10px 0; }
  </style>
</head>
<body>
  <h2>ÄÄƒng bÃ i tá»« file .zip</h2>
  <input type="text" id="filename" placeholder="TÃªn file HTML sau khi upload (vd: bai-viet-1.html)">
  <input type="file" id="zipFile" accept=".zip">
  <button onclick="handleUpload()">ğŸš€ Táº£i lÃªn GitHub</button>
  <p id="status"></p>

  <!-- JSZip Ä‘á»ƒ giáº£i nÃ©n -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    const GITHUB_TOKEN = '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';
    const REPO_OWNER = 'khetcompany';
    const REPO_NAME = 'khet';

    async function handleUpload() {
      const fileInput = document.getElementById('zipFile');
      const filename = document.getElementById('filename').value.trim();
      const status = document.getElementById('status');
      if (!fileInput.files[0] || !filename) return alert("Vui lÃ²ng chá»n file ZIP vÃ  nháº­p tÃªn bÃ i viáº¿t!");

      status.innerText = "â³ Äang xá»­ lÃ½...";

      try {
        const zip = await JSZip.loadAsync(fileInput.files[0]);
        let htmlContent = "";
        const imageUploads = [];

        // TÃ¬m file HTML Ä‘áº§u tiÃªn
        for (const [path, file] of Object.entries(zip.files)) {
          if (path.endsWith(".html") && !file.dir) {
            htmlContent = await file.async("string");

            // TÃ¬m táº¥t cáº£ src áº£nh vÃ  thay tháº¿ Ä‘Æ°á»ng dáº«n
            htmlContent = htmlContent.replace(/<img\s+[^>]*src="([^"]+)"[^>]*>/g, (match, src) => {
              const filename = src.split('/').pop();
              return match.replace(src, `/media/img-post/${filename}`);
            });

            // Encode HTML to base64
            const htmlBase64 = btoa(unescape(encodeURIComponent(htmlContent)));
            await uploadToGitHub(`post/${filename}`, htmlBase64);
          }
        }

        // Upload áº£nh
        for (const [path, file] of Object.entries(zip.files)) {
          if (!file.dir && /\.(jpg|jpeg|png|gif|webp)$/i.test(path)) {
            const imageData = await file.async("base64");
            const imageName = path.split('/').pop();
            await uploadToGitHub(`media/img-post/${imageName}`, imageData);
          }
        }

        status.innerText = "ğŸ‰ ÄÄƒng bÃ i thÃ nh cÃ´ng!";
      } catch (err) {
        console.error(err);
        status.innerText = "âŒ Lá»—i: " + err.message;
      }
    }

    async function uploadToGitHub(path, contentBase64) {
      const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`, {
        method: "PUT",
        headers: {
          "Authorization": `token ${GITHUB_TOKEN}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Tá»± Ä‘á»™ng upload ${path}`,
          content: contentBase64
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(`Upload tháº¥t báº¡i (${path}): ${error.message}`);
      }
    }
  </script>
</body>
</html>
