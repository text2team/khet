<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>CMS ÄÄƒng bÃ i tá»« file ZIP</title>
  <style>
    body { font-family: Arial; padding: 2rem; max-width: 600px; margin: auto; }
    input, button { width: 100%; padding: 10px; margin: 10px 0; }
  </style>
</head>
<body>
  <h2>ğŸ“¦ ÄÄƒng bÃ i tá»« file .zip</h2>
  <input type="text" id="token" placeholder="ğŸ”‘ DÃ¡n GitHub Token cá»§a báº¡n">
  <input type="text" id="filename" placeholder="ğŸ“„ TÃªn file bÃ i viáº¿t (vd: bai-viet-1.html)">
  <input type="file" id="zipFile" accept=".zip">
  <button onclick="handleUpload()">ğŸš€ Táº£i lÃªn GitHub</button>
  <p id="status"></p>

  <!-- JSZip -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    const REPO_OWNER = 'khetcompany';
    const REPO_NAME = 'khet';

    async function handleUpload() {
      const token = document.getElementById('token').value.trim();
      const fileInput = document.getElementById('zipFile');
      const filename = document.getElementById('filename').value.trim();
      const status = document.getElementById('status');

      if (!token || !fileInput.files[0] || !filename) {
        alert("â›” Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ token, tÃªn file vÃ  chá»n file ZIP.");
        return;
      }

      status.innerText = "â³ Äang xá»­ lÃ½ ZIP...";

      try {
        const zip = await JSZip.loadAsync(fileInput.files[0]);
        let htmlContent = "";

        // TÃ¬m file HTML & sá»­a Ä‘Æ°á»ng dáº«n áº£nh
        for (const [path, file] of Object.entries(zip.files)) {
          if (path.endsWith(".html") && !file.dir) {
            htmlContent = await file.async("string");

            // Sá»­a Ä‘Æ°á»ng dáº«n áº£nh trong HTML
            htmlContent = htmlContent.replace(/<img\s+[^>]*src="([^"]+)"[^>]*>/g, (match, src) => {
              const clean = src.split('/').pop();
              return match.replace(src, `/media/img-post/${clean}`);
            });

            const htmlBase64 = btoa(unescape(encodeURIComponent(htmlContent)));
            await uploadToGitHub(`post/${filename}`, htmlBase64, token);
          }
        }

        // Upload áº£nh
        for (const [path, file] of Object.entries(zip.files)) {
          if (!file.dir && /\.(jpg|jpeg|png|gif|webp)$/i.test(path)) {
            const imageData = await file.async("base64");
            const imageName = path.split('/').pop();
            await uploadToGitHub(`media/img-post/${imageName}`, imageData, token);
          }
        }

        status.innerText = "âœ… ÄÄƒng bÃ i thÃ nh cÃ´ng!";
      } catch (err) {
        console.error(err);
        status.innerText = "âŒ Lá»—i: " + err.message;
      }
    }

    async function uploadToGitHub(path, contentBase64, token) {
      const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`, {
        method: "PUT",
        headers: {
          "Authorization": `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Tá»± Ä‘á»™ng upload ${path}`,
          content: contentBase64
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(`âŒ Upload tháº¥t báº¡i (${path}): ${error.message}`);
      }
    }
  </script>
</body>
</html>
